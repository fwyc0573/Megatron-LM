# Memory Trace Visualization Scripts

This directory contains scripts for visualizing memory usage comparisons between real training runs and simulation runs using the Megatron-LM memory profiler.

## Files

- `visualize_memory_traces.sh` - Main visualization script with full options
- `quick_visualize.sh` - Quick start script for common use cases
- `example_usage.sh` - Example usage demonstrations and automatic testing
- `README_memory_visualization.md` - This documentation file

## Overview

The memory trace visualization functionality allows you to:

1. **Compare memory usage** between real training runs and simulation runs
2. **Generate plots** showing allocated memory over time for the last iteration
3. **Visualize theoretical memory usage** alongside actual usage
4. **Analyze memory patterns** across different ranks

## Prerequisites

### Python Dependencies
```bash
pip install matplotlib
```

### Memory Trace Files
You need JSON trace files generated by the Megatron memory profiler with the naming pattern:
```
memory_trace_rank*.json
```

These files are typically generated when running Megatron-LM with memory tracing enabled.

## Usage

### Quick Start (Recommended)

For most users, the quickest way to get started:

```bash
./examples/quick_visualize.sh
```

This script automatically detects common trace directories and runs the visualization with sensible defaults.

### Advanced Usage

For full control over options:

```bash
./examples/visualize_memory_traces.sh -r <real_traces_dir> -s <sim_traces_dir>
```

### With Custom Output Directory

```bash
./examples/visualize_memory_traces.sh -r <real_traces_dir> -s <sim_traces_dir> -o <output_dir>
```

### Command Line Options

- `-r, --real-dir DIR` - Directory containing real run memory traces (required)
- `-s, --sim-dir DIR` - Directory containing simulation memory traces (required)
- `-o, --output-dir DIR` - Output directory for generated plots (default: memory_plots)
- `-t, --show-theoretical` - Display theoretical memory lines in plots (default: disabled)
- `-h, --help` - Show help message

## Examples

### Example 1: Basic Comparison
```bash
./examples/visualize_memory_traces.sh -r memory_traces -s memory_traces_scaling
```

### Example 2: Custom Output Directory
```bash
./examples/visualize_memory_traces.sh -r memory_traces -s memory_traces_scaling -o my_plots
```

### Example 3: With Theoretical Memory Lines
```bash
./examples/visualize_memory_traces.sh -r memory_traces -s memory_traces_scaling -t
```

### Example 4: Absolute Paths with Theoretical Memory
```bash
./examples/visualize_memory_traces.sh \
    -r /path/to/real/traces \
    -s /path/to/sim/traces \
    -o /path/to/output \
    -t
```

## Output

The script generates PNG files with names like:
```
memory_comparison_rank_0.png
memory_comparison_rank_1.png
...
```

Each plot shows:
- **Real Run** - Solid line showing actual memory usage
- **Simulation** - Dashed line showing simulated memory usage
- **Static Memory** - Green horizontal lines showing baseline memory usage (always shown when available)
- **Theoretical Memory** - Red horizontal lines showing theoretical memory limits (only when --show-theoretical is enabled)

## Running Examples

To see example usage and run demonstrations:

```bash
./examples/example_usage.sh
```

This script will:
1. Show example commands
2. Check for existing trace directories
3. Run a demonstration if suitable directories are found

## Trace File Format

The expected JSON format for trace files:
```json
{
  "0": {
    "samples": [
      {
        "timestamp_s": 0.0,
        "reserved_memory_MB": 1024.0,
        "allocated_memory_MB": 512.0
      }
    ],
    "peak_allocated_MB": 600.0,
    "theoretical_memory_MB": 800.0,
    "static_memory_MB": 256.0
  }
}
```

**Note**: The `static_memory_MB` field is optional for backward compatibility. Older trace files without this field will still work correctly.

## Troubleshooting

### No trace files found
- Ensure your directories contain files matching `memory_trace_rank*.json`
- Check that memory tracing was enabled during your training runs

### matplotlib not found
```bash
pip install matplotlib
```

### Permission denied
```bash
chmod +x examples/visualize_memory_traces.sh
chmod +x examples/example_usage.sh
```

### Empty plots
- Verify that your trace files contain valid data
- Check that the JSON format matches the expected structure
- Ensure at least one iteration has sample data

## Integration with Megatron-LM

This visualization works with memory traces generated by:
- `megatron/profiler/trace_memory.py` - The memory tracking module
- Training scripts with `--trace-memory` enabled
- Simulation runs with memory profiling

## Advanced Usage

For direct Python usage of the underlying visualization function:

```python
from megatron.profiler.trace_memory import visualize_memory_comparison

paired_files = {
    '0': {'real': 'path/to/real/rank0.json', 'sim': 'path/to/sim/rank0.json'},
    '1': {'real': 'path/to/real/rank1.json', 'sim': 'path/to/sim/rank1.json'}
}

visualize_memory_comparison(paired_files, 'output_directory')
```
